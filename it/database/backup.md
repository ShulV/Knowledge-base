## bash-скрипт для бэкапа и архивирования
#bash #sh #backup #dump #pg_dump #gzip #daemon #sh
```bash
FIND=`which find`
PG_DUMP=`which pg_dump`
PG_BACKUP_FILE="spotic-`date +%Y-%m-%dT%H:%M:%S`.sql.gz"
DB_BACKUP_DIR="/srv/backup"

export PGPASSWORD="123"

$FIND $DB_BACKUP_DIR/ -type f -mtime +7 -name '*.gz' -delete
$PG_DUMP -h 127.0.0.1 -p 5432 -U pg_user -d some_db_name -F p --no-owner -w | gzip > $DB_BACKUP_DIR/$PG_BACKUP_FILE
chown backup_owner:backup_owner_group $DB_BACKUP_DIR/*
chmod 440 $DB_BACKUP_DIR/*
```

**which find**
`-type f` фильтрует результаты поиска только по файлам (без учета каталогов и других типов узлов)
`-mtime +7` критерий отбора файлов по времени модификации. Отбирает файлы, которые были изменены более семи суток назад. Число `+7` обозначает интервал времени старше указанного количества дней.
`-name '*.gz'` фильтр по имени файла. Будет выбрана только та группа файлов, имена которых заканчиваются на `.gz` (это архивные файлы gzip).
`-delete` — инструкция для удаления найденных файлов. Обратите внимание, что операция удаления необратима, и её следует использовать аккуратно.

**pg_dump**
`-h 127.0.0.1` указывает хост
`-p 5432`  порт
`-U pg_user`  имя пользователя для аутентификации в базе данных. Предполагается, что пользователь `pg_user` обладает необходимыми правами на чтение и экспорт данных.
`-d some_db_name` имя базы данных, из которой будет сделан дамп
`-F p` формат дампа. Значение `p` указывает на формат plain-text (текстовый формат), пригодный для восстановления через `psql`.
`--no-owner` отключает сохранение информации о владельцах объектов (таблиц, представлений и т.д.). Это упрощает восстановление дампа в другую среду, где владельцы объектов могут различаться.
`-w` не выдавать запрос на ввод пароля. Если сервер требует аутентификацию по паролю и пароль не доступен с помощью других средств, таких как файл `.pgpass`, попытка соединения не удастся. Этот параметр может быть полезен в пакетных заданиях и скриптах, где нет пользователя, который вводит пароль.
`| gzip` конвейер (pipe), позволяющий передать поток данных из предыдущего этапа (`pg_dump`) в утилиту `gzip`, сжимающую выходной файл.
`> dump_name.sql.gz` выводит сжатый результат в файл

---
